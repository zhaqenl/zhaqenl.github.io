<!DOCTYPE html>
<html lang="en"><head><title>What Is Clon and Why You Should Use It</title><meta charset="utf-8" /><meta content="width=device-width,initial-scale=1.0,user-scalable=yes" name="viewport" /><meta content="noodp,noydir" name="robots" /><meta content="What Is Clon and Why You Should Use It" name="description" /><meta content="clon, lisp, scripting, shell, guide" name="keywords" /><meta content="What Is Clon and Why You Should Use It" property="og:title" /><meta content="article" property="og:type" /><meta content="https://zhaqenl.github.io/en/clon/" property="og:url" /><meta content="https://avatars0.githubusercontent.com/u/29517051" property="og:image" /><link href="/static/ico/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180" /><link href="/static/ico/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" /><link href="/static/ico/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" /><link href="/static/ico/manifest.json" rel="manifest" /><link color="#5bbad5" href="/static/ico/safari-pinned-tab.svg" rel="mask-icon" /><meta content="#ffffff" name="theme-color" /><style media="all" type="text/css">html {    color: #DDD;    font-size: 1em;    font-family: Georgia, Cambria, Palatino, "Palatino Linotype", "Times New Roman", Times, serif;    line-height: 1.45;    text-align: left:    width: 100%;    max-width: 40em;    margin: 0 auto 0 auto;    padding: 0;}body {    border-top: hidden;    border-bottom: hidden;    background-color: #2A2A2E;    padding: 0 1.5em 1em 1.5em;    margin: 0;}#content {    -webkit-column-count: 1;    -moz-column-count: 1;    column-count: 1;}code {    font-size: 0.9em;    font-family: "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Lucida Console", "Courier New", Courier, monospace;    color: black;    display: inline-block;    font-weight: bold;}pre code {    font-size: 1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;    font-weight: normal;}kbd {    font-size: 1.1em;    padding: 0.1em 0.6em;    border: 1px solid #ccc;    font-family: monospace;    background-color: #f7f7f7;    color: #333;    -moz-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -webkit-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -moz-border-radius: 3px;    -webkit-border-radius: 3px;    border-radius: 3px;    display: inline-block;    margin: 0 0.1em;    text-shadow: 0 1px 0 #fff;    white-space: nowrap;}h1, h2, h3, h4, h5, h6 {    font-family: Calibri, "Gill Sans", "Gill Sans MT", "Myriad Pro", Myriad, "DejaVu Sans", Tahoma, Geneva, Helvetica, Arial, sans-serif;    margin-bottom: 0;}h1 {    font-size: 2.5em;    text-align: center;    border-bottom: 6px solid #DDD;}h2 {    font-size: 2.0em;    text-align: left;    border-bottom: 2px solid #DDD;}h3 {    font-size: 1.6em;    text-align: left;    border-bottom: 1px solid #7F7F7F;}h4 {    font-size: 1.5em;    text-align: left;}h5 {    font-size: 1.3em;    text-align: left;}a:visited,a:hover,a:focus { color:           #2cf; text-decoration: none; }a:link { color:           #d30; text-decoration: none;}a:hover,a:focus {    text-decoration: underline;}ul, ol {    padding-left: 2em;}ul li {    list-style-type: square;}ul li li {    list-style-type: disc;}ul li li li {    list-style-type: circle;}ol li {    list-style-type: decimal;}p, para, b, strong, i, em, emph {    font-size: 1em;}blockquote {    font-size: 1.2em;    font-style: italic;    margin-left: 2em;}b, strong {    font-weight: bold;}i, em, emph {    font-style: italic;}table {    margin: 0.5em;    border-spacing: 0;    border-collapse: collapse;}th, td {    border: 1px solid lightgray;    padding-top: 0;    padding-bottom: 0;    padding-left: 0.45em;    padding-right: 0.45em;}.text-right {    text-align: right;}.text-small {    font-size: small;}.text-x-small {    font-size: x-small;}.banner {    display: block;    width: 100%;    margin-left: auto;    margin-right: auto;}.footer {    text-align: right;    float: right;    max-width: 18em;}.cc {    border-width: 0}.center {    text-align: center;}</style><style media="all" type="text/css">/* Ewan Themes -- based 99.99% from Tomorrow Night Theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Original theme - https://github.com/chriskempson/tomorrow-theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Tomorrow Comment */.hljs-comment {  color: #969896;}/* Tomorrow Red */.hljs-variable,.hljs-attribute,.hljs-tag,.hljs-regexp,.ruby .hljs-constant,.xml .hljs-tag .hljs-title,.xml .hljs-pi,.xml .hljs-doctype,.html .hljs-doctype,.css .hljs-id,.css .hljs-class,.css .hljs-pseudo {  color: #cc6666;}/* Tomorrow Orange */.hljs-number,.hljs-preprocessor,.hljs-pragma,.hljs-built_in,.hljs-literal,.hljs-params,.hljs-constant {  color: #de935f;}/* Tomorrow Yellow */.ruby .hljs-class .hljs-title,.css .hljs-rule .hljs-attribute {  color: #f0c674;}/* Tomorrow Green */.hljs-string,.hljs-value,.hljs-inheritance,.hljs-header,.hljs-name,.ruby .hljs-symbol,.xml .hljs-cdata {  color: #b5bd68;}/* Tomorrow Aqua */.hljs-title,.css .hljs-hexcolor {  color: #8abeb7;}/* Tomorrow Blue */.hljs-function,.python .hljs-decorator,.python .hljs-title,.ruby .hljs-function .hljs-title,.ruby .hljs-title .hljs-keyword,.perl .hljs-sub,.javascript .hljs-title,.coffeescript .hljs-title {  color: #81a2be;}/* Tomorrow Purple */.hljs-keyword,.javascript .hljs-function {  color: #b294bb;}.hljs {  display: block;  overflow-x: auto;  background: #1d1f21;  color: #c5c8c6;  padding: 0.5em;  -webkit-text-size-adjust: none;}.coffeescript .javascript,.javascript .xml,.tex .hljs-formula,.xml .javascript,.xml .vbscript,.xml .css,.xml .hljs-cdata {  opacity: 0.5;}pre code {    font-size: 1.1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;}</style></head><body><div id="content"><h1>What Is Clon and Why You Should Use It</h1><p><div class="center">Last updated: August 3, 2018</div></p><p><img src="/pictures/clon.jpg" class="banner" alt="clon" /> <div style="text-align: right">  <i>Image by Alexis Angelidis via <a href='https://www.lrde.epita.fr/~didier/software/lisp/clon/user.pdf'>clon</a></i>  </div></p><p>In my pursuit of creating a Common Lisp successor of <a href='https://github.com/ebzzry/pell'>pell</a>, a host availability monitor, I stumbled upon <a href='https://www.lrde.epita.fr/~didier/software/lisp/clon.php'>Clon</a>. In hopes of taste-testing Clon, first, I went on to create the mksum subsystem of <a href='https://github.com/ebzzry/scripts'>scripts</a> and towards the end of this guide, I will talk a bit about the main differences between that experiment and pell.</p><h2>Table of Contents</h2><ul><li><a href='#preparation'>Preparation</a></li><li><a href='#what'>What is Clon?</a></li><li><a href='#why'>Why use Clon?</a></li><li><a href='#implementation'>Implementation</a><ul><li><a href='#initialization'>The initialization step</a></li><li><a href='#processing'>The processing step</a><ul><li><a href='#explicit'>Explicit</a></li><li><a href='#sequential'>Sequential</a></li></ul></li></ul></li><li><a href='#remainder'>The remainder</a></li><li><a href='#vs'>mksum vs. pelo</a></li><li><a href='#afternotes'>Afternotes</a></li></ul><h2><a name="preparation"></a> Preparation</h2><p>To experiment with what Clon offers itself, start with the installation of some system dependencies, on APT and Nixpkgs systems, respectively:</p><pre><code class="bash">sudo apt-get install -y sbcl git
</code></pre><pre><code class="bash">nix-env -i sbcl git
</code></pre><p>Install Quicklisp:</p><pre><code class="bash">curl -O https://beta.quicklisp.org/quicklisp.lisp
sbcl --load quicklisp.lisp --eval  '&#40;quicklisp-quickstart:install&#41;' --eval '&#40;let &#40;&#40;ql-util::&#42;do-not-prompt&#42; t&#41;&#41; &#40;ql:add-to-init-file&#41; &#40;ql:quickload :cl-launch&#41; &#40;sb-ext:quit&#41;&#41;'
</code></pre><p>After fulfilling those, run the following in sbcl:</p><pre><code>&#40;ql:quickload :clon&#41;
</code></pre><h2><a name="what"></a> What is Clon?</h2><p>Clon is an external CL library whose job is to track command-line options and do stuff with them. In comparison, CL doesn't have a built-in intuitive library for handling command-line options, whereas, Python has one called the <i>getopt</i> module.</p><p>Though, later in the discussion of Clon, one might be thinking, as I am now, while writing this:“Doesn’t Python have something like this?”</p><h2><a name="why"></a> Why use Clon?</h2><p>One of the main criteria that should be considered while writing code is readability.</p><p>Without Clon, in order to get what you need from the command-line, you’ll often be manually checking for an object’s membership among the arguments of the command-line, and even with decent code abstraction, code blocks could significantly be lengthier because of the testings, and the additional code abstractions. You also might sacrifice a bit of code readability just for the sake of <i>having the job done.™</i></p><p>With Clon, the user is provided more convenience in creating CL scripts that requires the user to process command-line options. It also equips the user with conveniences, like the trivial creation of a help page.</p><h2><a name="implementation"></a> Implementation</h2><p>The process of creating a Clon-powered CL script involves two main steps that needs to be done, sequentially. The first is the initialization step, and the second one is the processing step.</p><h3><a name="initialization"></a> The initialization step</h3><p>This first step is necessary as it will become the hat that the second step will pull its tricks from. This step requires the creation of two things–the <i>synopsis</i> and the <i>context.</i> The synopsis will become, sort of, like the CL return value, but sometimes, what we’re after is not the return value itself, but the side effect (like in a <i>defun</i>, the return value is the name of the function defined).</p><p>One of the effects of creating a synopsis is to become the script’s help page. Another one is to serve as the basis for where the context comes from. Lastly, it implicitly dictates the bounds of our script, like the options our script supports, or if it supports one, at all!</p><p>To walk through those steps in an example, here is a short program that uses Clon:</p><pre><code>&#40;in-package :cl-user&#41;
&#40;require &quot;asdf&quot;&#41;
&#40;asdf:make :net.didierverna.clon&#41;
&#40;use-package :net.didierverna.clon&#41;

&#40;defsynopsis &#40;:postfix &quot;HOST&quot;&#41;
    &#40;text :contents &quot;A short program.&quot;&#41;
  &#40;group &#40;:header &quot;Options:&quot;&#41;
         &#40;flag :short-name &quot;h&quot; :long-name &quot;help&quot;
               :description &quot;Print this help and exit.&quot;&#41;&#41;&#41;

&#40;defun main &#40;&#41;
  &quot;Entry point&quot;
  &#40;make-context&#41;
  &#40;when &#40;getopt :short-name &quot;h&quot;&#41;
    &#40;help&#41;
    &#40;exit&#41;&#41;&#41;
</code></pre><p>The first line is for entering the CL-USER package. The second and third lines are for loading Clon, to be able to use its functions. The <code>USE-PACKAGE</code> function will allow us to use the <code>&#40;MAKE-CONTEXT&#41;</code> form instead of the longer <code>&#40;NET.DIDIERVERNA.CLON:MAKE-CONTEXT&#41;</code>.</p><p>After that, is a <code>DEFSYNOPSIS</code> form:</p><pre><code>&#40;defsynopsis &#40;:postfix &quot;HOST&quot;&#41;
    &#40;text :contents &quot;A short program.&quot;&#41;
  &#40;group &#40;:header &quot;Options:&quot;&#41;
         &#40;flag :short-name &quot;h&quot; :long-name &quot;help&quot;
               :description &quot;Print this help and exit.&quot;&#41;&#41;&#41;
</code></pre><p>This is one of the conveniences offered by Clon. One of its effect is acting as the program’s limiter, dictating the possible options that the program is able to support. Another effect is that it serves as the help page of the created script.</p><p>Inside <code>MAIN</code>: </p><pre><code>&#40;defun main &#40;&#41;
  &quot;Entry point&quot;
  &#40;make-context&#41;
  &#40;when &#40;getopt :short-name &quot;h&quot;&#41;
    &#40;help&#41;
    &#40;exit&#41;&#41;&#41;
</code></pre><p>the <code>&#40;MAKE-CONTEXT&#41;</code> function gets invoked, which works in synergy with the <code>DEFSYNOPSIS</code> form. What <code>&#40;MAKE-CONTEXT&#41;</code> does, is to prepare and to set the scope for the harvesting of what the command-line contains.</p><h3><a name="processing"></a> The processing step</h3><p>The question now, is what does the first step have in store for us? There are two different methods we can use to determine that.</p><h4><a name="explicit"></a> Explicit</h4><p>The first is the <i>explicit</i> method. Here, we check via the <code>GETOPT</code> function of Clon, whether or not a particular option/flag is provided by the end-user, for example:</p><pre><code>&#40;defun main &#40;&#41;
  &quot;Entry point&quot;
  &#40;make-context&#41;
  &#40;when &#40;getopt :short-name &quot;h&quot;&#41;
    &#40;help&#41;
    &#40;exit&#41;&#41;&#41;
</code></pre><p>In the example above, it checks if the script is given the <code>-h</code> flag, which stands for the help page. </p><h4><a name="sequential"></a> Sequential</h4><p>The second method is <i>sequential</i>, which is the one that does more work. There are three submethods that acquires the command-line arguments sequentially, as a function and as two macros, but we’re only going to tackle the usage of the <code>do-cmdline-options</code> macro.</p><p><code>DO-CMDLINE-OPTIONS</code> is a macro that evaluates its body with <code>OPTION</code>, <code>NAME</code>, <code>VALUE</code>, and <code>SOURCE</code> bound to the return value of the function <code>GETOPT-CMDLINE</code>, one of the submethods to sequentially acquire the next command-line option. So what actually happens is, in a <code>DO-CMDLINE-OPTIONS</code>, <code>GETOPT-CMDLINE</code> returns four results which would be bound to the previous variables, then the body of <code>DO-CMDLINE-OPTIONS</code> gets evaluated.</p><p>Next, <code>DO-CMDLINE-OPTIONS</code> simply loops <code>GETOPT-CMDLINE</code> over all the command-line options (while simultaneously binding them), then evaluates its body. The body of <code>DO-CMDLINE-OPTIONS</code> will no longer be evaluated after the command-line options are exhausted.</p><p>For this method, we’re going to use, as an example, a code snippet from <a href='https://github.com/zhaqenl/pelo/blob/master/pelo.lisp#L170'>pelo</a>, which uses the <code>do-cmdline-options</code> macro:</p><pre><code>&#40;do-cmdline-options &#40;option name value source&#41;
    &#40;cond &#40;&#40;or &#40;string= name &quot;b&quot;&#41; &#40;string= name &quot;beep-online&quot;&#41;&#41; &#40;setf &#42;beep-online&#42; t&#41;&#41;
          &#40;&#40;or &#40;string= name &quot;B&quot;&#41; &#40;string= name &quot;beep-offline&quot;&#41;&#41; &#40;setf &#42;beep-offline&#42; t&#41;&#41;
          &#40;&#40;or &#40;string= name &quot;c&quot;&#41; &#40;string= name &quot;count&quot;&#41;&#41; &#40;setf &#42;count-p&#42; t&#41;
           &#40;setf &#42;count&#42; value&#41;&#41;
          &#40;&#40;or &#40;string= name &quot;i&quot;&#41; &#40;string= name &quot;interval&quot;&#41;&#41; &#40;setf &#42;interval&#42; value&#41;&#41;&#41;&#41;
</code></pre><p>The strategy used above is to scour the context for provided command-line options, then change the state of the constants, in order to change the behavior of the script.</p><h2><a name="remainder"></a> The remainder</h2><p>Finally, remember that I said previously, that the synopsis implicitly dictates what options our script can support. The synopsis will also dictate whether our script accepts a non-option argument through the value of its <code>:POSTFIX</code> argument, if there is one.</p><p>For example, in the synopsis definition of <code>pelo</code>, a <code>&#40;:POSTFIX &quot;HOST&quot;&#41;</code> form can be found, which means, that aside from supporting options and flags, the script requires one more argument, in our case, a <code>HOST</code>.</p><p>For that, Clon offers us the <code>REMAINDER</code> function, that gives us the ability to check for mandatory non-option arguments located in the command-line. In <a href='https://github.com/zhaqenl/pelo/blob/master/pelo.lisp#L76'>pelo</a>:</p><pre><code>&#40;defun host-present &#40;&#41;
  &quot;Check if host is provided.&quot;
  &#40;remainder :context &#40;make-context&#41;&#41;&#41;
</code></pre><h2><a name="vs"></a> mksum vs. pelo</h2><p>As promised, in this section, we’re going to discuss the only difference between mksum and pelo.  In <code>mksum.lisp</code> of <a href='https://github.com/zhaqenl/scripts'>scripts</a>, inside the entry-point function, we can clearly see the important difference between exclusively utilizing an explicit approach to getting the command-line arguments, versus utilizing both explicit and sequential approaches:</p><pre><code>&#40;defun mksum &#40;&amp;rest args&#41;
    &quot;The top-level function&quot;
    &#40;cond &#40;&#40;and &#40;get-opt &quot;s&quot;&#41; &#40;get-opt &quot;t&quot;&#41; &#40;remainder&#41;&#41; &#40;print-exit &#40;string-with &#40;remainder&#41;&#41;&#41;&#41;
          &#40;&#40;options-everywhere-p args&#41; &#40;print-exit &#40;weird-with args &#40;first-weird args&#41;&#41;&#41;&#41;
          &#40;&#40;valued-string-p&#41; &#40;print-preserve #'string-with&#41;&#41;
          &#40;&#40;and &#40;get-opt &quot;s&quot;&#41; &#40;remainder&#41;&#41; &#40;print-exit &#40;string-without &#40;remainder&#41;&#41;&#41;&#41;
          &#40;&#40;and &#40;get-opt &quot;t&quot;&#41; &#40;remainder&#41;&#41; &#40;print-exit &#40;option-with &#40;remainder&#41;&#41;&#41;&#41;
          &#40;&#40;remainder&#41; &#40;print-exit &#40;option-without &#40;remainder&#41;&#41;&#41;&#41;
          &#40;&#40;string-flag-p&#41; &#40;print-preserve #'string-without&#41;&#41;
          &#40;&#40;list-flag-p&#41; &#40;print-exit &#40;ironclad:list-all-digests&#41;&#41;&#41;
          &#40;t &#40;print-help&#41;&#41;&#41;&#41;&#41;

</code></pre><p>As I’ve mentioned earlier, even with code abstractions, the block of code still ends up clunky with all the extra tests, and the <i>coming-up-with</i> of all the possible cases.</p><h2><a name="afternotes"></a> Afternotes</h2><p>The idea of using the <code>DO-CMDLINE-OPTIONS</code> macro came from  <a href='https://github.com/ebzzry/pell/blob/master/pell#L85'>pell</a>. </p><p>The previous version of pelo didn’t have that structure at first, which lead me to write a lot of helper functions to aid (though, the code back then was still significantly longer than it is now) in readability, and for the checks for the options provided to the script.</p><p>The worst part is, inside the entry-point function, I had to come up with every single combination of all the existing options in order to cover all the cases (similar to what happened in mksum), which works, but is very inefficient and will give you more unnecessary work, because if you ever decide to go with that design philosophy, and you want to add more supported options to your scripts, you’d have a hard time coming up with all the case combinations.</p><p>That’s when I started playing around with the sequential method of acquiring the command-line options, and doing something with them, which pell helped me with to determine what that something is.</p><p>For a more detailed tutorial of the more advanced features of Clon, I strongly suggest you read the <a href='https://www.lrde.epita.fr/~didier/software/lisp/clon/user.pdf'>user</a> and the <a href='https://www.lrde.epita.fr/~didier/software/lisp/clon/enduser.pdf'>end-user</a> guides, though, Didier Verna suggests, that you start with the end-user guide.</p><hr/><div class="footer"><p><div class="text-small"> <a href='/en'>Home</a> · <a href='/en/about'>About</a> · <a href='https://github.com/zhaqenl/zhaqenl.github.io'>Source</a> </div> <div class="text-x-small"> Created with <a href='https://github.com/ebzzry/emem'>emem</a> <div></p><p><div class="text-x-small"> <a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/deed.en"><img alt="CC0 1.0 Universal (CC0 1.0) Public Domain Dedication" class="cc" src="/pictures/cc0-88x31.png" /></a><br> This work is in the <a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/deed.en">public domain.</a><br> </div></p><p></div></p></div><script src="/static/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create', 'UA-121960562-1', 'auto');ga('send', 'pageview');</script></body></html>