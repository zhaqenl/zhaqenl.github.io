<!DOCTYPE html>
<html lang="en"><head><title>A Clon Guide</title><meta charset="utf-8" /><meta content="width=device-width,initial-scale=1.0,user-scalable=yes" name="viewport" /><meta content="noodp,noydir" name="robots" /><meta content="A Clon Guide" name="description" /><meta content="clon, lisp, scripting, shell" name="keywords" /><meta content="A Clon Guide" property="og:title" /><meta content="article" property="og:type" /><meta content="https://zhaqenl.github.io/en/clon/" property="og:url" /><meta content="https://avatars0.githubusercontent.com/u/29517051" property="og:image" /><link href="/static/ico/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180" /><link href="/static/ico/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png" /><link href="/static/ico/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png" /><link href="/static/ico/manifest.json" rel="manifest" /><link color="#5bbad5" href="/static/ico/safari-pinned-tab.svg" rel="mask-icon" /><meta content="#ffffff" name="theme-color" /><style media="all" type="text/css">html {    color: #333;    font-size: 1em;    font-family: Georgia, Cambria, Palatino, "Palatino Linotype", "Times New Roman", Times, serif;    line-height: 1.45;    text-align: left:    width: 100%;    max-width: 40em;    margin: 0 auto 0 auto;    padding: 0;}body {    border-top: hidden;    border-bottom: hidden;    padding: 0 1.5em 1em 1.5em;    margin: 0;}#content {    -webkit-column-count: 1;    -moz-column-count: 1;    column-count: 1;}code {    font-size: 0.9em;    font-family: "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Lucida Console", "Courier New", Courier, monospace;    color: black;    display: inline-block;    font-weight: bold;}pre code {    font-size: 1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;    font-weight: normal;}kbd {    font-size: 1.1em;    padding: 0.1em 0.6em;    border: 1px solid #ccc;    font-family: monospace;    background-color: #f7f7f7;    color: #333;    -moz-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -webkit-box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    box-shadow: 0 1px 0px rgba(0, 0, 0, 0.2),0 0 0 2px #ffffff inset;    -moz-border-radius: 3px;    -webkit-border-radius: 3px;    border-radius: 3px;    display: inline-block;    margin: 0 0.1em;    text-shadow: 0 1px 0 #fff;    white-space: nowrap;}h1, h2, h3, h4, h5, h6 {    font-family: Calibri, "Gill Sans", "Gill Sans MT", "Myriad Pro", Myriad, "DejaVu Sans", Tahoma, Geneva, Helvetica, Arial, sans-serif;    margin-bottom: 0;}h1 {    font-size: 2.5em;    text-align: center;    border-bottom: 6px solid black;}h2 {    font-size: 2.0em;    text-align: left;    border-bottom: 2px solid black;}h3 {    font-size: 1.6em;    text-align: left;    border-bottom: 1px solid lightgrey;}h4 {    font-size: 1.5em;    text-align: left;}h5 {    font-size: 1.3em;    text-align: left;}ul, ol {    padding-left: 2em;}ul li {    list-style-type: square;}ul li li {    list-style-type: disc;}ul li li li {    list-style-type: circle;}ol li {    list-style-type: decimal;}p, para, b, strong, i, em, emph {    font-size: 1em;}blockquote {    font-size: 1.2em;    font-style: italic;    margin-left: 2em;}b, strong {    font-weight: bold;}i, em, emph {    font-style: italic;}table {    margin: 0.5em;    border-spacing: 0;    border-collapse: collapse;}th, td {    border: 1px solid lightgray;    padding-top: 0;    padding-bottom: 0;    padding-left: 0.45em;    padding-right: 0.45em;}.text-right {    text-align: right;}.text-small {    font-size: small;}.text-x-small {    font-size: x-small;}.banner {    display: block;    width: 100%;    margin-left: auto;    margin-right: auto;}.footer {    text-align: right;    float: right;    max-width: 18em;}.cc {    border-width: 0}.center {    text-align: center;}</style><style media="all" type="text/css">/* Ewan Themes -- based 99.99% from Tomorrow Night Theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Original theme - https://github.com/chriskempson/tomorrow-theme *//* http://jmblog.github.com/color-themes-for-google-code-highlightjs *//* Tomorrow Comment */.hljs-comment {  color: #969896;}/* Tomorrow Red */.hljs-variable,.hljs-attribute,.hljs-tag,.hljs-regexp,.ruby .hljs-constant,.xml .hljs-tag .hljs-title,.xml .hljs-pi,.xml .hljs-doctype,.html .hljs-doctype,.css .hljs-id,.css .hljs-class,.css .hljs-pseudo {  color: #cc6666;}/* Tomorrow Orange */.hljs-number,.hljs-preprocessor,.hljs-pragma,.hljs-built_in,.hljs-literal,.hljs-params,.hljs-constant {  color: #de935f;}/* Tomorrow Yellow */.ruby .hljs-class .hljs-title,.css .hljs-rule .hljs-attribute {  color: #f0c674;}/* Tomorrow Green */.hljs-string,.hljs-value,.hljs-inheritance,.hljs-header,.hljs-name,.ruby .hljs-symbol,.xml .hljs-cdata {  color: #b5bd68;}/* Tomorrow Aqua */.hljs-title,.css .hljs-hexcolor {  color: #8abeb7;}/* Tomorrow Blue */.hljs-function,.python .hljs-decorator,.python .hljs-title,.ruby .hljs-function .hljs-title,.ruby .hljs-title .hljs-keyword,.perl .hljs-sub,.javascript .hljs-title,.coffeescript .hljs-title {  color: #81a2be;}/* Tomorrow Purple */.hljs-keyword,.javascript .hljs-function {  color: #b294bb;}.hljs {  display: block;  overflow-x: auto;  background: #1d1f21;  color: #c5c8c6;  padding: 0.5em;  -webkit-text-size-adjust: none;}.coffeescript .javascript,.javascript .xml,.tex .hljs-formula,.xml .javascript,.xml .vbscript,.xml .css,.xml .hljs-cdata {  opacity: 0.5;}pre code {    font-size: 1.1em;    font-family: monospace;    line-height: 1.3em;    overflow: auto;}</style></head><body><div id="content"><h1>A Clon Guide</h1><p><img src="/pictures/clon.jpg" class="banner" alt="clon" /> <div style="text-align: right">  <i>Image by Alexis Angelidis via <a href='https://www.lrde.epita.fr/~didier/software/lisp/clon/user.pdf'>clon</a></i>  </div></p><p>To gain better <i>context</i> (pun retroactively intended) for the incoming discussion, I strongly suggest you first read the  <a href='https://www.lrde.epita.fr/~didier/software/lisp/clon/user.pdf'>user</a> and the <a href='https://www.lrde.epita.fr/~didier/software/lisp/clon/enduser.pdf'>end-user</a> guides, though Didier Verna suggests you start with the end-user guide.</p><h2>What is Clon?</h2><p>I highly suggest reading the guides linked above first, anyway, and I’ll quote the creator–Clon is a library for managing command-line options in standalone Common Lisp applications. In comparison to Python, Common Lisp doesn't have a built-in <i>intuitive</i> library for handling command-line options. Python has one, and it’s the <i>getopt</i> module (though later in the discussion of Clon, one might be thinking, as I am now, while writing this–Doesn’t Python have something like this?).</p><h2>Why use Clon?</h2><p>Couldn’t I just go ahead with what Common Lisp provides <i>in-house</i> and get away with additional <i>lines</i> of code with a bit of compromise in the readability department? You certainly can, but, why go through all that pain, when a there’s an available tool whose sole purpose is to help you with that?</p><p>What are the main differences? Without Clon, you’d find yourself manually checking for an object’s membership among the arguments of the command-line, and even with decent code abstraction, code blocks could significantly be lengthier because of the explicit testings. You also might, as previously alluded to, sacrifice a bit of code readability just for the sake of  <i>having the job done.</i></p><p>With Clon, the user is provided more convenience in creating Common Lisp scripts, that requires the user to process command-line options, and also equips the user with conveniences, like the trivial creation of a <i>help</i> page.</p><h2>Implementation</h2><p>The application I’m going to use as the practical example is <a href='https://github.com/zhaqenl/pelo'>pelo</a>, one of my children. As didierverna mentioned, there will be 2 main phases that one needs to traverse in order to use Clon effectively.</p><p>So, fire up your browser or your favorite text editor, then open <code>pelo.lisp</code> from that repository, put this window beside the one you just opened, and let’s begin Clon’s whittling.</p><h2>The initialization phase</h2><p>This first phase is necessary as it will become the hat that the second one will pull its tricks from. This step requires the creation of two things–the <i>synopsis</i> and the <i>context.</i> The <i>synopsis</i> will become, sort of, like the Common Lisp return value, but sometimes, what we’re after is not the return value itself, but the side effect (like in a <i>defun</i>). For example, inside  <code>pelo.lisp</code>, we accomplished the creation of the <i>synopsis</i> through:</p><pre><code>&#40;defsynopsis &#40;:postfix &quot;HOST&quot;&#41;
  &#40;text :contents &quot;Send ICMP ECHO&#95;REQUEST packets to network hosts. Press C-c, while pelo is
running, to end pelo and show the accumulated stats.
&quot;&#41;
  &#40;group &#40;:header &quot;Options:&quot;&#41;
         &#40;flag :short-name &quot;h&quot; :long-name &quot;help&quot;
               :description &quot;Print this help.&quot;&#41;
         &#40;lispobj :short-name &quot;i&quot; :long-name &quot;interval&quot;
                  :typespec 'fixnum :argument-name &quot;SECONDS&quot;
                  :description &quot;Ping interval.&quot;&#41;
         &#40;lispobj :short-name &quot;c&quot; :long-name &quot;count&quot;
                  :typespec 'fixnum :argument-name &quot;NUMBER&quot;
                  :description &quot;Number of packets to send.&quot;&#41;
         &#40;flag :short-name &quot;b&quot; :long-name &quot;beep-online&quot;
               :description &quot;Beep if host is up.&quot;&#41;
         &#40;flag :short-name &quot;B&quot; :long-name &quot;beep-offline&quot;
               :description &quot;Beep if host is down.&quot;&#41;&#41;&#41;
</code></pre><p>One of the effects of creating a <i>synopsis</i> is to become the script’s help page. Another one is to serve as the basis for where the <i>context</i> comes from. Lastly, it implicitly dictates the bounds of our script, like the options our script supports, or if it supports one at all!</p><p>After the creation of the synopsis, we now need to create the <i>context</i>, but where do we do that? Didier Verna mentions that you <i>cannot</i> create a <i>context</i> as a toplevel form, but technically, Common Lisp would allow you to do that, but the reason you are being discouraged from doing so is because when created as a toplevel form, the <i>context</i> being created would now be in relation to when the script is created, not when it will be run, as wanted.</p><p>We create a <i>context</i> through the <code>MAKE-CONTEXT</code> function, which you’ll notice inside <code>pelo.lisp</code>, is only found in <code>MAIN</code>, <code>HOST-PRESENT</code>, and <code>GET-OPT</code>. What <code>MAKE-CONTEXT</code> does, is to <i>prepare</i> for the harvesting of what the command-line contains, which will essentially be the passing of the baton from the first phase to the second.</p><h2>The processing phase</h2><p>The question now, is what snowflake of a baton did the first phase just pass to us? There are two different methods we can use to determine that, and in my case, I didn’t have to choose, because I used them both!</p><p>The first is the <i>explicit</i> method. Here, we <i>explictly</i> check via the <code>GETOPT</code> function of Clon, whether or not a particular option/flag is provided by the end-user, for example:</p><pre><code>&#40;getopt :short-name &quot;h&quot;&#41;
</code></pre><p>In the example above, it checks if the script is given the <code>-h</code> flag, which stands for the help page. In <code>pelo.lisp</code>, I also used it to determine whether or not the end-user requested the help page, either through providing the <i>short-named</i> flag <code>‑h</code>, or its <i>long-named</i> equivalent <code>‑‑help</code>.</p><p>The second method is the <i>sequential</i> one, which is the one that does more work, in my case. Inside, there are three submethods that it provides us with, as a function and as two macros. The one that fit my need the best is the <code>DO-CMDLINE-OPTIONS</code> macro:</p><pre><code>&#40;do-cmdline-options &#40;option name value source&#41;
    &#40;cond &#40;&#40;or &#40;string= name &quot;b&quot;&#41; &#40;string= name &quot;beep-online&quot;&#41;&#41; &#40;setf &#42;beep-online&#42; t&#41;&#41;
          &#40;&#40;or &#40;string= name &quot;B&quot;&#41; &#40;string= name &quot;beep-offline&quot;&#41;&#41; &#40;setf &#42;beep-offline&#42; t&#41;&#41;
          &#40;&#40;or &#40;string= name &quot;c&quot;&#41; &#40;string= name &quot;count&quot;&#41;&#41; &#40;setf &#42;count-p&#42; t&#41;
           &#40;setf &#42;count&#42; value&#41;&#41;
          &#40;&#40;or &#40;string= name &quot;i&quot;&#41; &#40;string= name &quot;interval&quot;&#41;&#41; &#40;setf &#42;interval&#42; value&#41;&#41;&#41;&#41;
</code></pre><p><code>DO-CMDLINE-OPTIONS</code> is a macro that evaluates its body with <code>OPTIONS</code>, <code>NAME</code>, <code>VALUE</code>, and <code>SOURCE</code> bound to the return value of the function <code>GETOPT-CMDLINE</code>, one of the submethods to sequentially acquire the next command-line option. So what actually happens is, in a <code>DO-CMDLINE-OPTIONS</code>, <code>GETOPT-CMDLINE</code> returns four results which would be bound to the previous variables, then the body of <code>DO-CMDLINE-OPTIONS</code> gets evaluated.</p><p>Next, <code>DO-CMDLINE-OPTIONS</code> simply loops <code>GETOPT-CMDLINE</code> over all the command-line options (while simultaneously binding them), then evaluates its body. The body of <code>DO-CMDLINE-OPTIONS</code> will no longer be evaluated after the command-line options are exhausted.</p><p>Finally, remember that I said previously, that the <i>synopsis</i> implicitly dictates what options our script can support. The <i>synopsis</i> will also dictate whether our script accepts a non-option argument. For example, in <code>pelo</code>’s case, it accepts a <i>host</i> argument, to be sent a ping request.</p><p>For that, Clon offers us the <code>REMAINDER</code> function, that gives us the ability to check for non-option arguments located in the command-line:</p><pre><code>&#40;defun host-present &#40;&#41;
  &quot;Check if host is provided.&quot;
  &#40;remainder :context &#40;make-context&#41;&#41;&#41;
</code></pre><h2>Miscellaneous</h2><p>As the <code>DO-CMDLINE-OPTIONS</code> is what I consider to be the cleanest part of the code, I owe it to where I got the idea from. The idea came from  <a href='https://github.com/ebzzry/pell/blob/master/pell#L85'>pell</a>. </p><p>The previous version of <i>pelo</i> didn’t have that structure at first, which lead me to write a lot of helper functions to <i>aid</i> (though the code back then was still significantly longer than it is now) in readability, and for the explicit checks for the options provided to the script.</p><p>The worst part is, inside the entry-point function, I had to come up with every single combination of all the existing options in order to cover all the cases, which works, but is very inefficient and will give you more unnecessary work, because, if you ever decide to go with that design philosophy, and you want to add more supported options to your scripts, well, guess what, you’d have a hard time coming up with all the case combinations.</p><p>That’s when I started playing around with the <i>sequential</i> method of acquiring the command-line options, and doing something with them, which <i>pell</i> helped me with to determine what that <i>something</i> is.</p><hr/><div class="footer"><p><div class="text-small"> <a href='/en'>Home</a> · <a href='/en/about'>About</a> · <a href='https://github.com/zhaqenl/zhaqenl.github.io'>Source</a> </div> <div class="text-x-small"> Created with <a href='https://github.com/ebzzry/emem'>emem</a> <div></p><p><div class="text-x-small"> <a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/deed.en"><img alt="CC0 1.0 Universal (CC0 1.0) Public Domain Dedication" class="cc" src="/pictures/cc0-88x31.png" /></a><br> This work is in the <a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/deed.en">public domain.</a><br> </div></p><p></div></p></div><script src="/static/js/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create', 'UA-121960562-1', 'auto');ga('send', 'pageview');</script></body></html>